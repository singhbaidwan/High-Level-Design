<svg xmlns="http://www.w3.org/2000/svg" width="2200" height="1240" viewBox="0 0 2200 1240">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#374151" />
    </marker>
    <style>
      .title { font: 700 30px Arial, Helvetica, sans-serif; fill: #0f172a; }
      .svc { fill: #eef2ff; stroke: #3730a3; stroke-width: 2; rx: 12; ry: 12; }
      .db { fill: #ecfeff; stroke: #0f766e; stroke-width: 2; rx: 12; ry: 12; }
      .ext { fill: #fff7ed; stroke: #c2410c; stroke-width: 2; rx: 12; ry: 12; }
      .bus { fill: #f0fdf4; stroke: #15803d; stroke-width: 2; rx: 12; ry: 12; }
      .ops { fill: #fefce8; stroke: #a16207; stroke-width: 2; rx: 12; ry: 12; }
      .label { font: 600 17px Arial, Helvetica, sans-serif; fill: #111827; text-anchor: middle; dominant-baseline: middle; }
      .line { stroke: #374151; stroke-width: 2.5; fill: none; marker-end: url(#arrow); }
      .note { font: 500 14px Arial, Helvetica, sans-serif; fill: #4b5563; }
    </style>
  </defs>

  <text x="1100" y="48" class="title" text-anchor="middle">Intermediate Design 4: Production Hardening (Scale and Resilience)</text>

  <rect class="svc" x="60" y="120" width="220" height="90" />
  <text class="label" x="170" y="165">Merchant</text>

  <rect class="svc" x="320" y="120" width="240" height="90" />
  <text class="label" x="440" y="165">Edge and WAF</text>

  <rect class="svc" x="600" y="120" width="220" height="90" />
  <text class="label" x="710" y="165">API Gateway</text>

  <rect class="svc" x="860" y="120" width="280" height="90" />
  <text class="label" x="1000" y="165">Refund API Pods</text>

  <rect class="svc" x="760" y="320" width="220" height="90" />
  <text class="label" x="870" y="365">AuthN and AuthZ</text>

  <rect class="db" x="1030" y="320" width="280" height="90" />
  <text class="label" x="1170" y="365">Idempotency Redis Cluster</text>

  <rect class="db" x="1360" y="300" width="360" height="120" />
  <text class="label" x="1540" y="360">Sharded OLTP: Payments, Refunds,</text>
  <text class="label" x="1540" y="388">Ledger, Outbox</text>

  <rect class="svc" x="1380" y="500" width="320" height="90" />
  <text class="label" x="1540" y="545">Outbox Relay Fleet</text>

  <rect class="bus" x="1380" y="660" width="320" height="90" />
  <text class="label" x="1540" y="705">Kafka or PubSub</text>

  <rect class="svc" x="1030" y="840" width="260" height="90" />
  <text class="label" x="1160" y="885">Refund Worker Fleet</text>

  <rect class="svc" x="1340" y="840" width="260" height="90" />
  <text class="label" x="1470" y="885">Circuit Breaker and Retry</text>

  <rect class="ext" x="1650" y="840" width="260" height="90" />
  <text class="label" x="1780" y="885">Provider Adapters</text>

  <rect class="ext" x="1940" y="840" width="220" height="90" />
  <text class="label" x="2050" y="885">PSP Providers</text>

  <rect class="svc" x="1840" y="660" width="300" height="90" />
  <text class="label" x="1990" y="705">Webhook Ingest Service</text>

  <rect class="ops" x="1740" y="500" width="220" height="90" />
  <text class="label" x="1850" y="545">Notifications</text>

  <rect class="ops" x="1990" y="500" width="180" height="90" />
  <text class="label" x="2080" y="545">Observability</text>

  <rect class="ops" x="1080" y="1020" width="320" height="90" />
  <text class="label" x="1240" y="1065">Reconciliation Jobs</text>

  <rect class="bus" x="1120" y="660" width="220" height="90" />
  <text class="label" x="1230" y="705">DLQ</text>

  <line class="line" x1="280" y1="165" x2="320" y2="165" />
  <line class="line" x1="560" y1="165" x2="600" y2="165" />
  <line class="line" x1="820" y1="165" x2="860" y2="165" />

  <line class="line" x1="980" y1="210" x2="900" y2="320" />
  <line class="line" x1="1040" y1="210" x2="1140" y2="320" />
  <line class="line" x1="1100" y1="210" x2="1450" y2="300" />

  <line class="line" x1="1540" y1="420" x2="1540" y2="500" />
  <line class="line" x1="1540" y1="590" x2="1540" y2="660" />

  <line class="line" x1="1410" y1="750" x2="1220" y2="840" />
  <line class="line" x1="1290" y1="885" x2="1340" y2="885" />
  <line class="line" x1="1600" y1="885" x2="1650" y2="885" />
  <line class="line" x1="1910" y1="885" x2="1940" y2="885" />

  <line class="line" x1="2050" y1="840" x2="1990" y2="750" />
  <line class="line" x1="1990" y1="660" x2="1570" y2="750" />
  <line class="line" x1="1840" y1="705" x2="1700" y2="705" />

  <line class="line" x1="1540" y1="750" x2="1850" y2="500" />
  <line class="line" x1="1540" y1="750" x2="2080" y2="500" />
  <line class="line" x1="1380" y1="705" x2="1340" y2="705" />

  <line class="line" x1="1500" y1="420" x2="1280" y2="1020" />
  <line class="line" x1="1330" y1="1065" x2="1700" y2="900" />
  <line class="line" x1="1180" y1="1020" x2="1460" y2="420" />

  <text class="note" x="112" y="250">edge rate limiting protects API</text>
  <text class="note" x="1330" y="628">async execution isolates provider latency</text>
  <text class="note" x="1040" y="972">reconciliation handles unknown outcomes</text>
</svg>
