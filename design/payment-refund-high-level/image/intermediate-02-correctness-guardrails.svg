<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="760" viewBox="0 0 1600 760">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#374151" />
    </marker>
    <style>
      .title { font: 700 28px Arial, Helvetica, sans-serif; fill: #0f172a; }
      .svc { fill: #eef2ff; stroke: #3730a3; stroke-width: 2; rx: 12; ry: 12; }
      .db { fill: #ecfeff; stroke: #0f766e; stroke-width: 2; rx: 12; ry: 12; }
      .ext { fill: #fff7ed; stroke: #c2410c; stroke-width: 2; rx: 12; ry: 12; }
      .label { font: 600 17px Arial, Helvetica, sans-serif; fill: #111827; text-anchor: middle; dominant-baseline: middle; }
      .line { stroke: #374151; stroke-width: 2.5; fill: none; marker-end: url(#arrow); }
      .dashed { stroke-dasharray: 10 7; }
      .note { font: 500 14px Arial, Helvetica, sans-serif; fill: #4b5563; }
    </style>
  </defs>

  <text x="800" y="46" class="title" text-anchor="middle">Intermediate Design 2: Correctness Guardrails</text>

  <rect class="svc" x="80" y="140" width="230" height="90" />
  <text class="label" x="195" y="185">Merchant Client</text>

  <rect class="svc" x="380" y="140" width="230" height="90" />
  <text class="label" x="495" y="185">API Gateway</text>

  <rect class="svc" x="680" y="140" width="280" height="90" />
  <text class="label" x="820" y="185">Refund API Service</text>

  <rect class="ext" x="1030" y="140" width="280" height="90" />
  <text class="label" x="1170" y="185">Payment Provider</text>

  <rect class="db" x="220" y="430" width="250" height="100" />
  <text class="label" x="345" y="480">Idempotency Store</text>

  <rect class="db" x="520" y="430" width="250" height="100" />
  <text class="label" x="645" y="480">Payments DB</text>

  <rect class="db" x="820" y="430" width="250" height="100" />
  <text class="label" x="945" y="480">Refunds DB</text>

  <rect class="db" x="1120" y="430" width="250" height="100" />
  <text class="label" x="1245" y="480">Ledger DB</text>

  <line class="line" x1="310" y1="185" x2="380" y2="185" />
  <line class="line" x1="610" y1="185" x2="680" y2="185" />
  <line class="line" x1="960" y1="185" x2="1030" y2="185" />

  <line class="line" x1="760" y1="230" x2="400" y2="430" />
  <line class="line" x1="805" y1="230" x2="670" y2="430" />
  <line class="line" x1="845" y1="230" x2="920" y2="430" />
  <line class="line" x1="880" y1="230" x2="1220" y2="430" />

  <line class="line dashed" x1="700" y1="430" x2="790" y2="230" />
  <line class="line dashed" x1="910" y1="230" x2="1170" y2="430" />

  <text class="note" x="634" y="352">check refundable balance in tx</text>
  <text class="note" x="930" y="336">write balanced ledger entries</text>
  <text class="note" x="230" y="585">idempotency key blocks duplicate retries</text>
</svg>
