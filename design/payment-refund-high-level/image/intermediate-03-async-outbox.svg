<svg xmlns="http://www.w3.org/2000/svg" width="1800" height="860" viewBox="0 0 1800 860">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#374151" />
    </marker>
    <style>
      .title { font: 700 28px Arial, Helvetica, sans-serif; fill: #0f172a; }
      .svc { fill: #eef2ff; stroke: #3730a3; stroke-width: 2; rx: 12; ry: 12; }
      .db { fill: #ecfeff; stroke: #0f766e; stroke-width: 2; rx: 12; ry: 12; }
      .ext { fill: #fff7ed; stroke: #c2410c; stroke-width: 2; rx: 12; ry: 12; }
      .bus { fill: #f0fdf4; stroke: #15803d; stroke-width: 2; rx: 12; ry: 12; }
      .label { font: 600 17px Arial, Helvetica, sans-serif; fill: #111827; text-anchor: middle; dominant-baseline: middle; }
      .line { stroke: #374151; stroke-width: 2.5; fill: none; marker-end: url(#arrow); }
      .dashed { stroke-dasharray: 9 7; }
      .note { font: 500 14px Arial, Helvetica, sans-serif; fill: #4b5563; }
    </style>
  </defs>

  <text x="900" y="46" class="title" text-anchor="middle">Intermediate Design 3: Asynchronous Execution with Outbox</text>

  <rect class="svc" x="80" y="140" width="230" height="90" />
  <text class="label" x="195" y="185">Merchant Client</text>

  <rect class="svc" x="360" y="140" width="230" height="90" />
  <text class="label" x="475" y="185">API Gateway</text>

  <rect class="svc" x="640" y="140" width="280" height="90" />
  <text class="label" x="780" y="185">Refund API Service</text>

  <rect class="db" x="520" y="350" width="520" height="110" />
  <text class="label" x="780" y="405">OLTP Core: Payments, Refunds, Ledger, Outbox</text>

  <rect class="db" x="1080" y="350" width="260" height="110" />
  <text class="label" x="1210" y="405">Refund Read Cache</text>

  <rect class="svc" x="620" y="560" width="220" height="90" />
  <text class="label" x="730" y="605">Outbox Relay</text>

  <rect class="bus" x="900" y="560" width="260" height="90" />
  <text class="label" x="1030" y="605">Refund Commands Topic</text>

  <rect class="svc" x="1220" y="560" width="220" height="90" />
  <text class="label" x="1330" y="605">Refund Worker</text>

  <rect class="ext" x="1500" y="560" width="220" height="90" />
  <text class="label" x="1610" y="605">Payment Provider</text>

  <rect class="bus" x="1220" y="720" width="260" height="90" />
  <text class="label" x="1350" y="765">Refund Status Events</text>

  <line class="line" x1="310" y1="185" x2="360" y2="185" />
  <line class="line" x1="590" y1="185" x2="640" y2="185" />

  <line class="line" x1="760" y1="230" x2="760" y2="350" />
  <line class="line" x1="850" y1="230" x2="1160" y2="350" />

  <line class="line" x1="760" y1="460" x2="730" y2="560" />
  <line class="line" x1="840" y1="605" x2="900" y2="605" />
  <line class="line" x1="1160" y1="605" x2="1220" y2="605" />
  <line class="line" x1="1440" y1="605" x2="1500" y2="605" />

  <line class="line dashed" x1="1500" y1="625" x2="1440" y2="625" />
  <path class="line" d="M 1260 560 C 1160 500, 980 500, 860 460" />
  <line class="line" x1="1330" y1="650" x2="1330" y2="720" />

  <text class="note" x="820" y="320">synchronous request path ends here (pending)</text>
  <text class="note" x="682" y="700">outbox removes commit-publish gap</text>
  <text class="note" x="1510" y="546">provider call retried with idempotency token</text>
</svg>
